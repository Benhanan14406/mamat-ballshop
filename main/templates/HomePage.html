{% extends "base.html" %}

{% block styles %}
    .title {
        color: black; 
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        text-align: left; 
        padding: 0.5cm; 
        padding-top: 2cm; 
        font-size: 250%; 
        max-width: 100%;
    }

    .button {
        align: center;
        background-color: indianred;
        font-family: Verdana, Geneva, Tahoma, sans-serif; 
        text-align: center; 
        font-size: 150%; 
        max-width: 10cm;
        left: 50%;
        float: center;
        border: 0.1cm;
        border-color: darkslategrey;
        border-style: solid;
        margin: 1cm;
    }

    .button a {
        color: aliceblue;
        margin-bottom: 1cm; 
    }

    .itemDisplay {
        background-color: aliceblue; 
        margin: 1cm; 
        margin-top: 1cm; 
        max-width: 7cm;
        height: fit-content
        white-space: nowrap; 
        font-size: 100vp;
        padding-top: 1cm;
        padding-bottom: 1cm;
        border: 0.1cm;
        border-color: darkslategrey;
        border-style: solid;
        float: left;
    }

    .itemDisplay a {
        text-decoration:none;
    }

    .itemDisplay .itemDetail {
        color: aliceblue; 
        font-family: Verdana, Geneva, Tahoma, sans-serif; 
        text-align: left; 
        overflow: hidden;
    }

    .itemDisplay .itemDetail img {
        width: 6.5cm;
        height: 6.5cm; 
        object-fit: contain;
    }

{% endblock %}

{% block extraHead %}
    <div class="mb-8">
        </div>
    <!-- Button to open modal -->
        <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-white text-green-600 font-semibold outline outline-2 outline-green-600 outline-offset-[-2px] rounded-md hover:bg-green-600 hover:text-white transition-colors mb-4">
        Create Product
        </button>
{% endblock %}

{% block content %}
    {% comment %} <div style = "font-size: 125%; color: black; padding-top: 2cm; ;">
        Current user: {{ username }}

        <div>
            <a href="{% url "logout" %}">
                <button>
                    Logout
                </button>
            </a>
        </div>
    </div> {% endcomment %}
    {% comment %} <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div> {% endcomment %}

    <h1 class = "title">
        <b>
            Products in Stock
        </b>
    </h1>

    {% comment %} <div class = "button">
        <a href = "{% url "createProduct" %}">
            Create New Product
        </a>
    </div> {% endcomment %}

    <div>
        <a href = "?filter=all">
            <button type="button">
                All Products
            </button>
        </a>
    </div>

    <div>
        <a href = "?filter=my">
            <button type="button">
                My Products
            </button>
        </a> 
    </div>

    <div style = "min-height: 7cm;">

        <!-- Loading State -->
        <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
        <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p class="text-gray-600 mt-3">Loading news...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden"></div>

        <!-- News Grid -->
        <div id="grid" class="hidden"></div>

        <!-- Empty State -->
        <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
        <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
        <a href="{% url 'createProduct' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
            Create News
        </a>
        </div>

    {% if productList %}
        {% for product in productList %}
                <div class = "itemDisplay">
                    <a href = "{% url "productDetails" product.id %}">
                        <b class = "itemDetail" >
                            <div style = "font-size: 150%; color: black; margin-bottom: 0.5cm;">
                                {{ product.name }}
                            </div>

                            <img src = {{ product.thumbnail }} alt = {{ product.name }}>

                            <div style = "font-size: 100%; color: black; margin-top: 0.5cm;">
                                Seller: {{ product.user }}
                            </div>

                            <div style = "font-size: 100%; color: black; margin-top: 0.5cm;">
                                {{ product.description }}
                            </div>

                            <div style = "font-size: 125%; color: black;">
                                Price: {{ product.price }}
                            </div>
                        </b>
                    </a>
                </div>
            {% endfor %} 
        {% else %}
            <b style = "color:black; font-family: Verdana, Geneva, Tahoma, sans-serif; text-align: left; padding: 0.125cm; padding-top: 1cm; font-size: 100%;">
                No products for sale
            </b>
        {% endif %}
    </div>

    <script>
        // Configuration
        const PRODUCTS_API_ENDPOINT = "{% url 'showJSON' %}";
        const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

        // DOM Elements
        const loadingSpinner = document.getElementById('loading');
        const errorMessage = document.getElementById('error');
        const emptyStateDisplay = document.getElementById('empty');
        const newsGridContainer = document.getElementById('grid');
        const showAllProductsButton = document.getElementById('filter-all');
        const showMyProductsButton = document.getElementById('filter-my');

        // State Variables
        let activeFilter = 'all';
        let allProductData = [];

        // Update filter button appearance
        function updateFilterButtonsAppearance() {
            if (!showAllProductsButton || !showMyProductsButton) return;
            
            if (activeFilter === 'all') {
                showAllProductsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
                showMyProductsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
            } else {
                showMyProductsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
                showAllProductsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
            }
        }

        // Show/hide page sections
        function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
        loadingSpinner.classList.toggle('hidden', !showLoading);
        errorMessage.classList.toggle('hidden', !showError);
        emptyStateDisplay.classList.toggle('hidden', !showEmpty);
        newsGridContainer.classList.toggle('hidden', !showGrid);
        
        // Add grid classes when showing grid
        if (showGrid) {
            newsGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
        }
        }

        // Get readable category name
        function getReadableCategoryName(categoryCode) {
            const categoryMapping = {
                transfer: 'Transfer',
                update: 'Update',
                exclusive: 'Exclusive',
                match: 'Match',
                rumor: 'Rumor',
                analysis: 'Analysis',
            };
            return categoryMapping[categoryCode] || categoryCode;
        }

        // Create news card element
        function buildProductsCardElement(product) {
            const articleElement = document.createElement('article');
            articleElement.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

            const detailLink = `{% url 'productDetails' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', product.id);
            const editLink = `{% url 'editProduct' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', product.id);
            const deleteLink = `{% url 'deleteProduct' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', product.id);
        }
        
        const seller = DOMurify.sanitize(product.user);
        const name = DOMurify.sanitize(product.name);
        const price = DOMurify.sanitize(product.price);
        const stock = DOMurify.sanitize(product.stock);
        const size = DOMurify.sanitize(product.lingkar);
        const description = DOMPurify.sanitize(product.description);
        const categoryLabel = getReadableCategoryName(product.category);
        const isFeatured = DOMPurify.sanitize(product.is_featured);

        const thumbnailHtml = product.thumbnail 
            ? `<img src='${product.thumbnail}' alt='${product.name}' class='w-full h-full object-cover'>` 
            : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'></div>`;

        const featuredBadge = isFeatured 
            ? `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>` 
            : '';

        const editDeleteButtons = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(product.user_id)
            ? `<div class='flex space-x-2'>
                <a href='${editLink}' class='text-gray-600 hover:text-gray-700 text-sm transition-colors'>Edit</a>
                <a href='${deleteLink}' class='text-red-600 hover:text-red-700 text-sm transition-colors' onclick='return confirm("Are you sure you want to delete this article?")'>Delete</a>
            </div>`
            : '';

        const completeCardHtml = `
            <div class="aspect-[16/9] relative overflow-hidden">
                ${thumbnailHtml}
                <div class="absolute top-3 left-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white">${categoryLabel}</span>
                </div>
                <div class="absolute top-3 right-3 flex space-x-2">
                    ${featuredBadge}
                </div>
            </div>
            <div class="p-5 flex flex-col flex-1">
                <div class="flex items-center text-sm text-gray-500 mb-3">
                    <span class="mx-2">â€¢</span>
                </div>

                <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
                    <a href="${detailLink}" class="hover:text-green-600 transition-colors">${product.name}</a>
                </h3>

                <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${product.description}</p>
                <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
                    <a href="${detailLink}" class="text-green-600 hover:text-green-700 font-medium text-sm transition-colors">Read more</a>
                    ${editDeleteButtons}
                </div>
            </div>
        `;

        articleElement.innerHTML = completeCardHtml;
        return articleElement;

        // Render all news cards
        function renderAllProductCards(product) {
            newsGridContainer.innerHTML = '';
            product.forEach(product => {
                const cardElement = buildProductsCardElement(product);
                newsGridContainer.appendChild(cardElement);
            });
        }

        // Filter and display news
        function filterAndDisplayProducts() {
            updateFilterButtonsAppearance();
            
            const filteredProducts = activeFilter === 'all' 
                ? allProductData 
                : allProductData.filter(products => Number(product.user_id) === Number(CURRENT_USER_ID));
            
            if (filteredProducts.length === 0) {
                displayPageSection({ showEmpty: true });
            } else {
                renderAllProductCards(filteredProducts);
                displayPageSection({ showGrid: true });
            }
        }

        // Fetch news data from server
        async function fetchProductsFromServer() {
            try {
                displayPageSection({ showLoading: true });
                
                const response = await fetch(PRODUCTS_API_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
                });

                if (!response.ok) {
                throw new Error('Failed to fetch product data from server');
                }

                const productData = await response.json();
                allProductData = productData || [];
                
                filterAndDisplayProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                displayPageSection({ showError: true });
            }
        }

        // Event handlers
        function handleShowAllProductsClick() {
            activeFilter = 'all';
            filterAndDisplayProducts();
        }

        function handleShowMyProductsClick() {
            activeFilter = 'my';
            filterAndDisplayProducts();
        }

        // Initialize page
        function initializeProductsPage() {
            showAllProductsButton.addEventListener('click', handleShowAllProductsClick);
            showMyProductsButton.addEventListener('click', handleShowMyProductsClick);
            
            fetchProductsFromServer();
        }

        // Start application
        initializeProductsPage();

        document.addEventListener('productAdded', function() {
            // Refresh data without page reload
            fetchProductsFromServer();
        });
    </script>

    {% include 'modal.html' %}
{% endblock %}