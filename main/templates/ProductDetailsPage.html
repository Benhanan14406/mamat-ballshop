{% extends "base.html" %}

{% block styles %}
    .details {
        color: black; 
        font-family: Verdana, Geneva, Tahoma, sans-serif; 
        text-align: left; 
        height: fit-content;
    }

    .details h1 {
        padding-top: 2rem; 
        font-size: 2rem;
    }

    .details p {
        color: black; 
        font-family: Verdana, Geneva, Tahoma, sans-serif; 
        text-align: left; 
        font-size: 1rem; 
        padding-top: 0.5rem; 
    }

    .back-button {
        background-color: darkslategrey; 
        display: inline-block;
        margin: 1rem 0;
        border-radius: 4px;
    }

    .back-button a {
        color: white;
        font-family: Verdana, Geneva, Tahoma, sans-serif; 
        text-decoration: none;
        margin: 0;
        font-size: 1rem;
        padding: 0.5rem 1rem;
        display: block;
    }

    .back-button a:hover {
        background-color: #505860;
    }

    .details img {
        width: 10rem;
        height: 10rem; 
        object-fit: contain; 
        margin-top: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .product-info {
        background-color: #f9f9f9;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: bold;
        color: #333;
        min-width: 120px;
    }

    .info-value {
        color: #666;
        flex: 1;
        margin-left: 1rem;
        word-break: break-word;
    }

    .price-highlight {
        font-size: 1.75rem;
        color: #d9534f;
        font-weight: bold;
        margin-top: 0.5rem;
    }

    .loading-state {
        text-align: center;
        padding: 2rem;
    }

    .error-state {
        text-align: center;
        padding: 2rem;
        color: #d32f2f;
    }

    .hidden {
        display: none;
    }
{% endblock %}

{% block content %} 
    <div class="details">
        <div class="back-button">
            <a href="{% url 'main:homepage' %}">← Back to Home</a>
        </div>

        <div id="loading-state" class="loading-state">
            <svg class="animate-spin h-8 w-8 text-green-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p style="color: black; font-size: 1.25rem;">Loading product details...</p>
        </div>

        <div id="error-state" class="error-state hidden">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚠️</div>
            <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Failed to load product</h3>
            <p>Product not found.</p>
        </div>

        <div id="content-state" class="hidden">
            <h1><b id="name-display">Product Name</b></h1>

            <p style="font-size: 0.9rem; color: #666;">Sold by: <strong id="seller-display">Anonymous</strong></p>

            <img id="image" src="https://via.placeholder.com/300?text=No+Image" alt="Product Image" style="width: 10rem; height: 10rem; object-fit: contain;">

            <div class="product-info">
                <div class="info-row">
                    <span class="info-label">Description:</span>
                    <span class="info-value" id="description-display">N/A</span>
                </div>

                <div class="info-row">
                    <span class="info-label">Category:</span>
                    <span class="info-value" id="category-display">N/A</span>
                </div>

                <div class="info-row">
                    <span class="info-label">Size (Circumference):</span>
                    <span class="info-value"><span id="size-display">N/A</span> cm</span>
                </div>

                <div class="info-row">
                    <span class="info-label">Rating:</span>
                    <span class="info-value" id="review-display">No ratings yet</span>
                </div>

                <div style="margin-top: 1rem;">
                    <div class="price-highlight" id="price-display">Rp 0</div>
                    <div id="stock-badge"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PRODUCT_ID = "{{ product.id }}";
        const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:showJSONbyID' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);

        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const contentState = document.getElementById('content-state');

        function showState(state) {
            loadingState.classList.toggle('hidden', state !== 'loading');
            errorState.classList.toggle('hidden', state !== 'error');
            contentState.classList.toggle('hidden', state !== 'ready');
        }

        function getStockBadge(stock) {
            if (stock === 0) {
                return '<div style="background-color: #f8d7da; color: #721c24; padding: 0.5rem 1rem; border-radius: 4px; margin-top: 0.5rem; font-weight: 500;">Out of Stock</div>';
            } else if (stock <= 5) {
                return `<div style="background-color: #fff3cd; color: #856404; padding: 0.5rem 1rem; border-radius: 4px; margin-top: 0.5rem; font-weight: 500;">⚠️ Only ${stock} left in stock!</div>`;
            } else {
                return `<div style="background-color: #d4edda; color: #155724; padding: 0.5rem 1rem; border-radius: 4px; margin-top: 0.5rem; font-weight: 500;">✓ In Stock (${stock} available)</div>`;
            }
        }

        function renderProduct(product) {
            document.title = `${product.name} - Mamat Ballshop`;
            
            document.getElementById('name-display').textContent = product.name || 'N/A';
            document.getElementById('seller-display').textContent = product.user || 'Anonymous';
            document.getElementById('description-display').textContent = product.description || 'N/A';
            document.getElementById('category-display').textContent = product.category || 'N/A';
            document.getElementById('size-display').textContent = product.lingkar || 'N/A';
            
            const formattedPrice = Number(product.price).toLocaleString('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            document.getElementById('price-display').textContent = formattedPrice;
            
            document.getElementById('stock-badge').innerHTML = getStockBadge(product.stock);
            
            if (product.reviewCount > 0) {
                const rating = product.review.toFixed(1);
                document.getElementById('review-display').textContent = `${rating} / 5.0 (${product.reviewCount} reviews)`;
            }
            
            const imageUrl = product.thumbnail;
            document.getElementById('image').src = imageUrl;
            document.getElementById('image').alt = product.name;
        }

        async function loadProductDetail() {
            try {
                showState('loading');
                
                const response = await fetch(PRODUCT_DETAIL_ENDPOINT, {
                    headers: { 'Accept': 'application/json' },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch product detail');
                }

                const productArray = await response.json();
                if (!productArray || productArray.length === 0) {
                    throw new Error('Product not found');
                }

                const product = productArray[0];
                renderProduct(product);
                showState('ready');
            } catch (error) {
                console.error('Error loading product detail:', error);
                showState('error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadProductDetail);
    </script>
{% endblock %}